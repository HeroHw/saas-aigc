## 项目概述
本项目旨在构建一个多层级的AI服务管理和分发平台，从顶层的AI网关（对接各类大模型）到底层的最终用户，中间通过总控、多级代理和租户进行管理和资源分配。
## 技术栈
- 前端：vue3,ts,vite,uniocss
- 后端：PHP8.3
- 中间件：Redis, Nginx, Pgsql

## 系统架构组件及开发方案
系统主要包含以下几个核心组件：

1. AI网关 (基于 one-api)
   - 描述 ：作为系统的统一AI能力入口，对接各大AI模型供应商，并提供用量统计。
   - 核心功能 (利用 https://github.com/songquanpeng/one-api ) ：
     - 模型对接 ：配置和管理与不同AI模型（如OpenAI, Azure, Claude, 文心一言, 通义千问等）的连接。
     - 统一API接口 ：为上层应用（即“总控”）提供一个标准化的API调用方式，屏蔽底层不同模型的接口差异。
     - 渠道管理 ：在 one-api 中设置不同的模型渠道和相应的API Key。
     - 令牌管理 ：生成和管理访问 one-api 服务的令牌（API Keys）。
     - 用量统计与日志 ：记录通过 one-api 的所有API调用日志和用量消耗，能够按令牌或渠道进行统计。
     - 计费与配额 ： one-api 支持额度管理，可以为令牌设置额度。
   - 集成与部署 ：
     - 按照 one-api 的官方文档进行部署（例如使用 Docker）。
     - 总控系统将作为 one-api 的主要管理用户或通过其API进行集成，获取和管理 one-api 的令牌，并将这些令牌或其衍生的授权分配给下级。
2. 总控 (Master Control)
   - 描述 ：系统的中心管理节点，从AI网关获取授权，并管理下级代理。
   - 核心功能 ：
     - AI网关集成 ：
       - 安全存储和管理用于访问AI网关 ( one-api ) 的主API密钥或管理员凭证。
       - 通过API与 one-api 交互，可能包括创建和管理 one-api 中的令牌/渠道，或获取 one-api 的令牌池以供分配。
       - 同步或定期获取 one-api 的用量数据，进行汇总分析。
     - 顶级代理管理 ：
       - 创建、审核、启用/禁用顶级代理账户。
       - 向顶级代理分配从AI网关获取的资源配额（例如，API调用次数、token数量）。
     - 系统监控与管理 ：
       - 提供管理后台，展示整个系统的运行状态、资源使用情况、各顶级代理的用量等。
       - 管理系统级配置。
     - API接口 ：为下级（顶级代理）提供注册、认证、资源申请、用量查询等API。
   - 关键技术/考量 ：
     - 后端技术栈：可选用 Node.js (Express/NestJS), Python (Django/Flask), Java (Spring Boot), Go 等。
     - 数据库：用于存储代理信息、配额分配、系统配置、日志摘要等 (如 PostgreSQL, MySQL, MongoDB)。
     - 认证授权：为代理提供安全的API认证机制 (如 OAuth 2.0, JWT)。
     - 管理后台UI：便于管理员操作。
3. 代理 (无限级)
   
   - 描述 ：中间层级，可以发展下级代理或租户，并管理其直属下级。
   - 核心功能 ：
     - 注册与认证 ：向上级（总控或其他父代理）注册并获取授权和资源配额。
     - 下级代理管理 (递归) ：
       - 创建、审核、管理其直属的下级代理账户。
       - 向下级代理分配其自身获得的资源配额的一部分。
     - 租户管理 ：
       - 创建、审核、管理其直属的租户账户。
       - 向租户分配应用访问权限和资源配额。
     - 权限隔离 ：每个代理只能管理其直接发展的下级代理和租户，不能跨级管理。
     - 请求转发与计费 ：
       - 接收来自下级代理或租户的AI服务请求。
       - 对请求进行认证和鉴权，检查配额。
       - 将合法的请求向上级转发，最终到达AI网关。
       - 精确记录下级代理和租户的用量，并向上级汇报或自身进行扣减。
     - 管理界面 ：为代理提供一个管理其直属下级和租户、查看用量、分配配额的界面。
   - 关键技术/考量 ：
     - 与总控类似的技术栈选型。
     - 数据库设计需支持层级关系（例如邻接表、路径枚举、闭包表等方式存储代理层级）。
     - API设计：为下级代理和租户提供清晰的API接口。
     - 配额管理的原子性和一致性。
4. 租户 (Tenant)
   - 描述 ：直接服务于最终用户的实体，使用上级代理授权的应用。
   - 核心功能 ：
     - 注册与授权 ：向其所属的代理注册，并获取AI应用的使用权限和资源配额。
     - 用户管理 ：
       - 租户管理员可以创建、管理自己租户内的最终用户账户。
       - 可以为租户内的用户分配不同的权限或子配额（可选功能）。
     - 应用使用 ：
       - 提供用户界面（UI）或API，让其名下的最终用户能够使用被授权的AI应用。
       - 例如，提供一个聊天界面或API接口供其用户调用。
     - 请求代理 ：将最终用户的AI请求，通过其上级代理，最终路由到AI网关。
     - 用量统计与展示 ：统计并向租户管理员展示其名下所有用户的总用量，以及（可选）单个用户的用量。
   - 关键技术/考量 ：
     - 技术栈选择，可能需要前端技术 (React, Vue, Angular) 来构建用户界面。
     - 多租户数据隔离。
     - 用户认证与会话管理。
5. 用户 (User)
   
   - 描述 ：AI服务的最终消费者。
   - 核心功能 ：
     - 通过所属租户提供的界面或API，注册/登录账户。
     - 使用租户授权的AI功能。
     - （可选）查看自己的使用量和剩余配额。
## 整体通用考虑因素
- 认证与授权 ：设计一套贯穿各层级的安全认证授权机制（如JWT）。确保请求的来源可信，且有权访问相应资源。
- API设计 ：所有模块间的交互应通过定义良好、版本化的RESTful API或gRPC进行。
- 计费与配额系统 ：需要精确、实时地跟踪和控制各层级的用量和配额，防止超额使用。
- 日志与监控 ：建立完善的日志系统（请求日志、错误日志、操作日志）和监控系统（系统性能、API响应时间、资源使用率），便于问题排查和运营分析。
- 可伸缩性 ：架构设计应考虑未来的业务增长，关键模块（如请求转发、计费）应能水平扩展。
- 安全性 ：API密钥等敏感信息的安全存储、防止API滥用、数据传输加密等。
- 错误处理与容错 ：各层级都需要妥善处理来自上下游的错误，并提供一定的容错能力。
## 建议开发阶段 (高层次)
1. 阶段一：核心骨架搭建
   - 部署并熟悉 one-api (AI网关)。
   - 开发总控核心功能：与 one-api 对接，手动创建顶级代理并分配 one-api 令牌。
   - 开发单级代理核心功能：从总控获取授权，手动创建租户并分配资源。
   - 开发租户核心功能：从代理获取授权，允许最终用户通过简单方式发出AI请求，并能成功通过代理、总控到达 one-api 。
   - 打通最简请求链路：用户 -> 租户 -> 代理 -> 总控 -> AI网关 -> AI模型。
2. 阶段二：完善代理层级与租户功能
   - 实现代理的无限级功能（代理可以创建子代理）。
   - 完善各层级的配额分配与管理逻辑。
   - 开发租户的用户管理功能。
   - 初步的管理后台界面（总控、代理、租户）。
3. 阶段三：增强与优化
   - 完善各级管理后台的功能和用户体验。
   - 实现详细的用量统计和展示。
   - 加强系统的安全性、稳定性和可伸缩性。
   - 引入全面的日志和监控。
4. 阶段四：测试与上线
   - 进行全面的功能测试、性能测试、安全测试。
   - 准备上线部署。